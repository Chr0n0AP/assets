#
# ===================== COPYRIGHT NOTICE =====================
# This file is protected by Copyright. Please refer to the COPYRIGHT file
# distributed with this source distribution.
# 
# This file is part of REDHAWK.
#  
# REDHAWK is free software: you can redistribute it and/or modify it
# under the terms of the GNU Lesser General Public License as published by the
# Free Software Foundation, either version 3 of the License, or (at your
# option) any later version.
# 
# REDHAWK is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License
# for more details.
# 
# You should have received a copy of the GNU Lesser General Public License
# along with this program. If not, see http://www.gnu.org/licenses/.
# ============================================================
#
# Internal Use Only: Sub-level Makefile that allows building the C++ objects
# multi-threaded. (The primary Makefile is intentionally single-threaded.)

ifeq ($(VRT_CC),clang++)
cpp_lib/libvrt.so:				$(cpp_source_files) \
						$(cpp_header_files) \
						$(wildcard cpp_src/vrt/libm/*.h) \
						$(wildcard cpp_src/vrt/libm/*.cc)
	@echo ""
	@echo "================================================================"
	@echo "Build C++ Shared Object"
	@echo "================================================================"
	mkdir -p cpp_lib
	$(cpp_compiler) $(cpp_build_flags) $(cpp_includes) $(cpp_link_flags) \
	    -shared -o cpp_lib/libvrt.so $(wildcard cpp_src/vrt/*/*.cc)

cpp_lib/vrttest:				$(cpptest_source_files) \
						$(cpptest_header_files) \
						$(cpp_header_files) \
						cpp_lib/libvrt.so
	@echo ""
	@echo "================================================================"
	@echo "Build C++ Test Code"
	@echo "================================================================"
	mkdir -p cpp_lib
	$(cpp_compiler) $(cpp_build_flags) $(cpptest_includes) $(cpp_link_flags) \
	     -lvrt -Lcpp_lib/ -o cpp_lib/vrttest $(cpptest_source_files)
else
cpp_src/%.o:cpp_src/%.cc			cpp_src/%.cc \
						$(wildcard cpp_src/vrt/*/*.h)
	$(cpp_compiler) -c $(cpp_build_flags) $(cpp_includes) -static -o $(@) $(<)

cpp_test/%.o:cpp_test/%.cc			cpp_test/%.cc \
						$(wildcard cpp_src/vrt/*/*.h) \
						$(wildcard cpp_test/vrttest/*/*.h)
	$(cpp_compiler) -c $(cpp_build_flags) $(cpptest_includes) -static -o $(@) $(<)

cpp_lib/libvrt.so:				$(cpp_obj_files) \
						cpp_src/vrt/lib/PackUnpack.o \
						$(patsubst %.h,%.o,$(wildcard cpp_src/vrt/libm/*.h))
	@echo ""
	@echo "================================================================"
	@echo "Build C++ Shared Object"
	@echo "================================================================"
	mkdir -p cpp_lib
	$(cpp_compiler) $(cpp_build_flags) $(cpp_link_flags) \
	    -shared -o cpp_lib/libvrt.so cpp_src/vrt/*/*.o
	@echo ""
	@echo "================================================================"
	@echo "Build C++ Static Library"
	@echo "================================================================"
	ar cru cpp_lib/libvrt-static.a cpp_src/vrt/*/*.o
	ranlib cpp_lib/libvrt-static.a

cpp_lib/vrttest:				$(cpptest_obj_files) cpp_lib/libvrt.so
	@echo ""
	@echo "================================================================"
	@echo "Build C++ Test Code"
	@echo "================================================================"
	mkdir -p cpp_lib
	$(cpp_compiler) $(cpp_build_flags) $(cpp_link_flags) -lvrt \
	    -Lcpp_lib/ -o cpp_lib/vrttest $(cpptest_obj_files)
endif
